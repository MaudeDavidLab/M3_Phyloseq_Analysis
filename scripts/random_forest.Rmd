---
title: "random_forest"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Tree_M3_datasets/M3_Phyloseq_Analysis_breastfedout//scripts/")
library(caret)
library(randomForest)
library(tibble)
library(ROCR)
library(dplyr)
library(reshape2)
library(phyloseq)
library(glmnet)
library(stringr)
library(ggpubr)
library(grid)
library(gridExtra)
library(ggplot2)
library(pROC)
source('../clean_mapping_ml.R')
```

# Load data
```{r}
output_data <- "../results/"
ps_not_norm_comp <- readRDS("../data/ps_not_norm_age_filter_complete_family.rds")
ps_deseq <- readRDS(paste0(output_data, "Filtered/ps_deseq_friedfilt.rds"))
ps_css <- readRDS(paste0(output_data, "Filtered/ps_css_friedfilt.rds"))
sig_res <- read.table(paste0(output_data, "significant_taxa_timeseries.tsv"), row.names = 1, sep = "\t", header = T)
sig_res_all <- read.table(paste0(output_data, "significant_taxa_all.tsv"), row.names = 1, sep = "\t", header = T)
```
### Will remake DESeq2 sam_data for the following code to work (Lifestyle_Variables formatting was changed in norm obj, and this obj isnt compatible with current code unless following chunk is used)

```{r}
ps_not_norm_comp <- readRDS("../data/ps_not_norm_age_filter_complete_family.rds")

#Remove Breastfed and their families
breast_fed <- c("089_A","054_N", "158_N" )

b_fed<-unique(ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Host.Name %in% breast_fed)])

#remove the whole family
for (i in b_fed){
  ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != i, ps_not_norm_comp)

}


#Remove Possible Contradictions and their families
possible_phen_contra <- c("020_A","131_A", "184_A" )

p_con<-unique(ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Host.Name %in% possible_phen_contra)])

#remove the whole family
for (i in p_con){
  ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != i, ps_not_norm_comp)

}

ps_deseq@sam_data<-sample_data(ps_not_norm_comp)

```


### Lifestyle_Variables for ML
```{r echo = F, results = 'hide'}

map_keep <- keepImportantColumns(ps_deseq@sam_data, metabol = F)
rownames(map_keep) <- map_keep$biospecimen_id
write.csv(map_keep, file = "../data/map_keep.csv")
map_keep<-read.csv(file = "../data/map_keep.csv", row.names = "X")

#Added makeFieldNumeric already in the filtering_normalization.rmd, so not needed here, so will omit
map_num <- makeFieldsNumeric(map_keep)
#select doesnt work for my session for some reason
#map_num <-map_num %>% select(-c(MARA, date))
map_num <- map_num[,-which(colnames(map_num) %in% c("MARA", "date"))]
nums <- as.vector(unlist(lapply(map_num, is.numeric)) )
map_num[, !nums] <- lapply(map_num[, !nums], factor)
map_num$stool_freq <- as.numeric(map_num$stool_freq)
sample_data(ps_deseq) <- map_num

```

### Random Forest

```{r randomforest}
#Random Forest main function
rand_forest <- function(pred_sequences, ps, include_taxa = T, include_meta = F, seed = 1){ 
  set.seed(seed)
  phen <- sample_data(ps)$phenotype
  fam_id <- sample_data(ps)$familyID
  data <- NULL
  if(include_taxa){
    ps <- prune_taxa(pred_sequences, ps )
    data <- t(otu_table(ps))
    
    #taxa names for plot labels
    species_names <- as.character(ps@tax_table[, 7])
    genus_names <- as.character(ps@tax_table[, 6])
    family_names <- as.character(ps@tax_table[, 5])
    taxa <- species_names
    taxa[taxa == "s__unclassified"] = genus_names[taxa == "s__unclassified"]
    taxa[taxa == "g__unclassified"] = family_names[taxa == "g__unclassified"]
    colnames(data) <- taxa
    
  }
  if(include_meta){
    Lifestyle_Variables <- data.frame(ps@sam_data)
    Lifestyle_Variables <- Lifestyle_Variables %>% select(-c(familyID, biospecimen_id, biospecimen_name, host_name, timepoint, age, dietary_restriction, dietary_supplement, sex, probiotic, vitamin_B, vitamin_D, multivitamin, racial_group))
    Lifestyle_Variables <- rfImpute(phenotype ~., Lifestyle_Variables)
    Lifestyle_Variables <- Lifestyle_Variables %>% select(-c(phenotype))
    if(is.null(data)){
      data <- Lifestyle_Variables
    }else{
      data <- data.frame(cbind(data, Lifestyle_Variables))
    }
  }
  data <- data.frame(phen, data, fam_id)
  
  
  folds_by_family <- groupKFold(fam_id, 5)
  data <- data %>% select(-c(fam_id))
  
  validate <- data[-folds_by_family[[1]],]
  training <- data[folds_by_family[[1]],]
  

  
  control <- trainControl(method='repeatedcv', 
                        number=3, 
                        repeats=3)

  tree_depths <- round(seq(2, ncol(data), by = ncol(data) / 6))
  tunegrid <- expand.grid(.mtry= tree_depths) #mtry is the depth of each decision tree
  
  rf <- train(phen ~., 
            data = training, 
            method='rf', 
            metric='Accuracy', 
            tuneGrid=tunegrid, 
            trControl=control)


  mtry_best = as.numeric(rf$bestTune)
  print(paste0("Tree depth: ", mtry_best))

  pred_votes <- c()
  outputlist <- list()
  for(i in 1:10){
    AR.classify <- randomForest(phen~., data = training, ntree = 128, mtry = mtry_best, importance = TRUE)
    rf <- AR.classify
    OOB.votes <- predict(rf, validate[,-1], type="prob");
    OOBpred_votes <- OOB.votes
  
    pred_votes <-  OOBpred_votes[,2]
    pred.obj <- prediction(pred_votes, data[names(pred_votes), ]$phen)
    
    #roc (tpr / fpr) perforamnce 
    roc_perf <- performance(pred.obj,"tpr", "fpr") #Calculate the AUC value
    auc_roc <- performance(pred.obj, "auc")@y.values[[1]]
    
    
    perf_obj <-list()
    perf_obj[[1]] <- auc_roc
    perf_obj[[2]] <- roc_perf
    perf_obj[[3]] <- rf
    labels_ordered<-ordered(data[names(pred_votes), ]$phen, levels = c("N", "A"))
    perf_obj[[4]] <- ci.auc(labels_ordered, pred_votes)
    outputlist[[i]] <- perf_obj
  }
  return(outputlist)
}
```



```{r}
plotAUCs <- function(perf_obj, col_ind = 1, plot_name = ""){
  avg_auc <- mean(unlist(lapply(perf_obj, function(x) return(x[[1]]))))
  plot(perf_obj[[1]][[2]], col = rainbow(8)[col_ind])
  for(i in 2:length(perf_obj)){
    plot(perf_obj[[i]][[2]], col = rainbow(8)[col_ind], add = T)   
  }
  abline(a=0, b= 1)
  text(.9, .1, paste0("AUC: ", round(avg_auc, 3)))
  title(plot_name)
  print(avg_auc)
}

get_avg_auc <-function(perf_obj){
  avg_auc <- mean(unlist(lapply(perf_obj, function(x) return(x[[1]]))))
  return(avg_auc)
}
plotAUCs_multiple <- function(perf_obj_list, plot_name = ""){
  j = 1
  add = F
  for(perf_obj in perf_obj_list){
    col_ind = j
    avg_auc <- mean(unlist(lapply(perf_obj, function(x) return(x[[1]]))))
    if(j>1){
      add = T
    }
    plot(perf_obj[[1]][[2]], col = rainbow(8)[col_ind], add = add)
    #for(i in 2:length(perf_obj)){
    #  plot(perf_obj[[i]][[2]], col = rainbow(8)[col_ind], add = add)   
    #}
    abline(a=0, b= 1)
    text(.9, .1, paste0("AUC: ", round(avg_auc, 3)))
    j = j + 1
  }
  legend("bottomright", legend = c("Meta", "Meta + markers", "Meta + null"), fill = c(rainbow(8)[1], rainbow(8)[2], rainbow(8)[3]))

}
```



### Just Lifestyle_Variables
```{r fig.height = 4, fig.width=8, echo = F}
meta_values <- NULL
perf_objs_meta <- list()
for (i in 0:9){
  print(i)
  perf_obj_meta <- rand_forest(pred_sequences = NA, ps = ps_deseq, include_taxa = F, include_meta = T, seed = i)
  i = i + 1
  perf_objs_meta[[i]] <- perf_obj_meta
  tmp_values<-unlist(lapply(perf_obj_meta, function(x) return(x[[1]])))
  meta_values <- c(meta_values, tmp_values)
}
summary(meta_values)
saveRDS(meta_values, file = "../results/full_meta_values.rds")
saveRDS(perf_objs_meta, file = "../results/full_meta_perfobjs.rds")

metadf<-data.frame('Lifestyle_Variables_only' = meta_values) #,  'meta_null_dist_no_db_sig' = meta_null_nodoublesig)
metadf<-melt(metadf)
#plotAUCs(perf_obj_meta, 1, "Model Using Lifestyle Variables Only")


```

```{r, fig.height = 6, fig.width = 7}
#varImpPlot(perf_obj_meta[[1]][[3]])
```

### Lifestyle_Variables and taxa selected by two methods in mixed effect model
```{r fig.height = 4, fig.width=8}
use <- grepl(",", sig_res$method)
biomarker_values <- NULL
perf_objs_bio <- list()
for (i in 0:9){
print(i)
perf_obj_biomarkers <- rand_forest(pred_sequences = rownames(sig_res)[use], ps = ps_deseq, include_taxa = T, include_meta = T, seed = i)
i = i + 1
perf_objs_bio[[i]] <- perf_obj_biomarkers
tmp_values<-unlist(lapply(perf_obj_biomarkers, function(x) return(x[[1]])))
biomarker_values <- c(biomarker_values, tmp_values)
}
summary(biomarker_values)
saveRDS(biomarker_values, file = "../results/full_biomarker_values.rds")
saveRDS(perf_objs_bio, file = "../results/full_biomarker_perfobjs.rds")

biodf<-data.frame('Lifestyle_Variables_and_11_Biomarkers' = biomarker_values) #,  'meta_null_dist_no_db_sig' = meta_null_nodoublesig)
biodf<-melt(biodf)

#plotAUCs(perf_obj_biomarkers, 3, "Model Using Lifestyle Variables and 11 Significant Taxa in Two Methods")
```

```{r, fig.height = 6.75, fig.width = 10}
#average importance over all 10 trees
imp_list <- list()
imp_list_of_lists <- list()
b = 1
for (x in perf_objs_bio){
  i = 1
  for(obj in x){
   model = obj[[3]]
   imp_list[[i]] <- data.frame(importance(model)) %>% select(-c("A", "N"))
   i = i + 1
  }
  imp_list_of_lists[[b]] <- imp_list
  b = b + 1
}
imp_df_all <-  do.call(cbind.data.frame, imp_list_of_lists[[1]])
for (y in 2:10){
imp_df_tmp <- do.call(cbind.data.frame, imp_list[[y]])
imp_df_all<-cbind(imp_df_all, imp_df_tmp)
}
imp_df<-imp_df_all
saveRDS(imp_df, "../imp_df.rds")

rownames(imp_df) <- gsub("f__", "", rownames(imp_df))
rownames(imp_df) <- gsub("g__", "", rownames(imp_df))
rownames(imp_df) <- gsub("s__", "_", rownames(imp_df))
rownames(imp_df) <- gsub("_B", "B", rownames(imp_df))
rownames(imp_df) <- gsub("min_time_", "months_since_last_", rownames(imp_df))
rownames(imp_df) <- gsub("nonceliac_", "nonceliac_gluten_", rownames(imp_df))
rownames(imp_df) <- gsub("meat_ready_eat", "ready_to_eat_meals", rownames(imp_df))
rownames(imp_df) <- gsub("env_tobacco", "secondhand_tobacco_exposure", rownames(imp_df))
rownames(imp_df) <- gsub("_B", "B", rownames(imp_df))

imp_df$lifestyle_variable <- rownames(imp_df)
melted <- melt(imp_df)
melted_gini <- melted[melted$variable == "MeanDecreaseGini", ]


melted_acc <- melted[melted$variable == "MeanDecreaseAccuracy", ]

ggplot(melted_gini, aes(x = reorder(lifestyle_variable, value), y = value)) +
  geom_boxplot() + geom_jitter(width = .2) + coord_flip() + theme_bw() + ggtitle("Variable Importance in Lifestyle Variables + 11 Biomarker Random Forest Model") +
  xlab("Predictor Variable") + ylab("Mean Decrease Gini") + theme(axis.text.y = element_text(size = 10.0))

a<-reorder(melted_gini$lifestyle_variable, melted_gini$value)
top_30 <- names(attr(a, "scores")[order(attr(a, "scores"), decreasing = "TRUE")][1:30])
melted_gini<-melted_gini[melted_gini$lifestyle_variable %in% top_30, ]

ggplot(melted_gini, aes(x = reorder(lifestyle_variable, value), y = value)) +
  geom_boxplot() + geom_jitter(width = .2) + coord_flip() + theme_bw() + ggtitle("Top 30 Predictors within Lifestyle Variables + 11 Biomarker Random Forest Model") +
  xlab("Predictor Variable") + ylab("Mean Decrease Gini") + theme(axis.text.y = element_text(size = 12.0), axis.title.x = element_text(size = 13.0), axis.title.y = element_text(size = 13.0), axis.text.x = element_text(size = 12.0), plot.title = element_text(size = 14.0))


ggplot(melted_acc, aes(x = reorder(lifestyle_variable, value), y = value)) +
  geom_boxplot() + geom_jitter(width = .002) + coord_flip() + theme_bw() + ggtitle("Variable Importance in Lifestyle Variable + 11 Biomarker Random Forest Model") +
  xlab("Predictor Variable") + ylab("Mean Decrease in Accuracy")

```
### Lifestyle_Variables and 11 randomly selected taxa
```{r fig.height = 3, fig.width=5}
set.seed(1)
amt <- grepl(",", sig_res$method)
use <- sample(taxa_names(ps_deseq)[-which(taxa_names(ps_deseq) %in% rownames(sig_res)[amt])], length(rownames(sig_res)[amt]))
perf_obj_rand <- rand_forest(pred_sequences = use, ps = ps_deseq, include_taxa = T, include_meta = T)
plotAUCs(perf_obj_rand, 3, "11 randomly selected taxa and Lifestyle_Variables")
```

### Lifestyle_Variables and 11 randomly selected taxa (new seed = 2)
```{r fig.height = 3, fig.width=5}
set.seed(2)
amt <- grepl(",", sig_res$method)
use <- sample(taxa_names(ps_deseq)[-which(taxa_names(ps_deseq) %in% rownames(sig_res)[amt])], length(rownames(sig_res)[amt]))
perf_obj_rand2 <- rand_forest(pred_sequences = use, ps = ps_deseq, include_taxa = T, include_meta = T)
plotAUCs(perf_obj_rand2, 3, "11 randomly selected taxa and Lifestyle_Variables (Subset_2)")
```

### Lifestyle_Variables and 11 randomly selected taxa (new seed = 3)
```{r fig.height = 3, fig.width=5}
set.seed(3)
amt <- grepl(",", sig_res$method)
use <- sample(taxa_names(ps_deseq)[-which(taxa_names(ps_deseq) %in% rownames(sig_res)[amt])], length(rownames(sig_res)[amt]))
perf_obj_rand3 <- rand_forest(pred_sequences = use, ps = ps_deseq, include_taxa = T, include_meta = T)
plotAUCs(perf_obj_rand3, 3, "11 randomly selected taxa and Lifestyle_Variables (Subset_3)")
```
### Lifestyle_Variables and 11 randomly selected taxa distribution
```{r fig.height = 8, fig.width=13.5, results='hide'}
perf_objs_null <- list()
null_auc_dist_values_some_sig_res <- NULL
null_auc_dist_full_values <- NULL
for(i in 0:9){
set.seed(i)
amt <- grepl(",", sig_res$method)
use <- sample(taxa_names(ps_deseq)[-which(taxa_names(ps_deseq) %in% rownames(sig_res)[amt])], length(rownames(sig_res)[amt]))
perf_obj_rand3 <- rand_forest(pred_sequences = use, ps = ps_deseq, include_taxa = T, include_meta = T)
tmp_values<-unlist(lapply(perf_obj_rand3, function(x) return(x[[1]])))
null_auc_dist_full_values <- c(null_auc_dist_full_values, tmp_values)
null_auc_dist_values_some_sig_res<-c(null_auc_dist_values_some_sig_res, get_avg_auc( perf_obj_rand3))
perf_objs_null[[i+1]] <- perf_obj_rand3
}
summary(null_auc_dist_values_some_sig_res)
saveRDS(perf_objs_null, file = "../results/full_null_perfobjs.rds")
#null_auc_dist_values_no_sig_res <- NULL
#for(i in 100:199){
#set.seed(i)
#amt <- grepl(",", sig_res$method)
#use <- sample(taxa_names(ps_deseq)[-which(taxa_names(ps_deseq) %in% rownames(sig_res))], length(rownames(sig_res)[amt]))
#perf_obj_rand3 <- rand_forest(pred_sequences = use, ps = ps_deseq, include_taxa = T, include_meta = T)
#null_auc_dist_values_no_sig_res<-c( null_auc_dist_values_no_sig_res, get_avg_auc(perf_obj_rand3))
#}
#summary(null_auc_dist_values_no_sig_res)

summary(null_auc_dist_full_values)
saveRDS(null_auc_dist_full_values, file = "../results/full_null_dist_values.rds")
meta_null_nosig<-null_auc_dist_full_values
#meta_null_nodoublesig <-null_auc_dist_values_no_sig_res
nulldf<-data.frame('Random_Taxa_and_Lifestyle_Variables' = meta_null_nosig) #,  'meta_null_dist_no_db_sig' = meta_null_nodoublesig)
nulldf<-melt(nulldf)
#auc_meta <- lapply(perf_obj_meta, function(x) return(x[[1]]))
#auc_meta_bio <- lapply(perf_obj_biomarkers, function(x) return(x[[1]]))

#df <- data.frame('Lifestyle_Variables_only' = unlist(auc_meta), 'Lifestyle_Variables_and_11_Biomarkers' = unlist(auc_meta_bio))
#df<-melt(df)
df_all<-rbind( metadf, biodf, nulldf)


my_comparison <- list(c("Lifestyle_Variables_only", "Lifestyle_Variables_and_11_Biomarkers"), c("Lifestyle_Variables_only","Random_Taxa_and_Lifestyle_Variables"), c("Lifestyle_Variables_and_11_Biomarkers","Random_Taxa_and_Lifestyle_Variables"))#, #c("meta_bio","meta_null_dist_no_db_sig"), c("meta","meta_null_dist_no_db_sig"))

ggplot(df_all, aes(x = variable, y = value, color = variable)) + geom_boxplot() + geom_jitter(width = .2) + theme_bw() +stat_compare_means(comparisons = my_comparison, label = "p.signif", hide.ns =TRUE)+labs(title="Comparison between Random Forest Model AUC Values",x ="Predictors Used", y = "AUC", color = "Predictors Used")

saveRDS(df_all, "../rf_for_plot.rds")
df_all<-readRDS("../rf_for_plot.rds")
myplot<-ggplot(df_all, aes(x = variable, y = value, color = variable)) + geom_boxplot() + geom_jitter(width = .2) + theme(axis.text.x = element_blank(), axis.text = element_text(size=14), title = element_text(size = 16), legend.text = element_text(size = 14), legend.key.size = unit(1.5,"line")) +stat_compare_means(comparisons = my_comparison, label = "p.signif", hide.ns =TRUE)+labs(title="Comparison between Random Forest Model AUC Values",x ="Predictors Used", y = "AUC", color = "Predictors Used") + scale_color_manual(values = c("#D0312D", "#8F389E", "#DF8236"))
#"#B65FCF", "#E7B800", "#FC4E07"
col_1<-c("Pet.dog","Pet.cat", "Minimum.time.since.antibiotics",
                  "Stool.frequency","Born.by.caesarian.section",
                  "Specific.food.allergy","GI.issues.this.week" ,
                  "Other.GI.symptoms",
                  "Gluten.allergy","Non.celiac.gluten.sensitivity",
                  "Whole.grain.consumption","Fermented.vegetable..consumption",
                  "Dairy.consumption","Fruit..consumption",
                  "Meals.prepared.at.home.consumption","Ready.to.eat.meals.consumption",
                  "Meat.consumption","Olive.oil.used.in.cooking",
                  "Seafood..consumption",
                  "Sugary.food.consumption")
 col_2<-c("Diet.during.infancy","Lactose.intolerance","Restaurant.prepared.meals.consumption", "Vegetable..consumption","Sweetened.drink..consumption","Born.prematurely",
                  "Environmental.tobacco.smoke.exposure",
                  "Diarrhea","Constipation",
                  "Starchy.food.consumption.longitudinal",
                  "Meats.and.seafood.consumption.longitudinal",
                  "Bread.consumption.longitudinal","Dairy.consumption.longitudinal",
                  "Dietary.fat.and.oil.consumption.longitudinal",
                  "Vegetable.consumption.longitudinal",
                  "Fruit.consumption.longitudinal",
                  "Natural.father.current.age..months", "Natural.mother.current.age..months", "Recently.ill", "")
table_names <- tibble(col_1, col_2)
colnames(table_names) <- c("Lifestyle and Dietary Variables selected", " ")

## get the legend 
tmp <- ggplot_gtable(ggplot_build(myplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) ==  "guide-box")
legend <- tmp$grobs[[leg]]
## create inset table
my_table <- tableGrob(table_names, rows = NULL, theme = ttheme_default(base_size = 10, padding = unit(c(2, 2), "mm")))


### final result 
grid.arrange(myplot + theme(legend.position = "none", plot.margin = unit(c(0.5, -1.5, 0.5, 0.5), "cm")), arrangeGrob(legend, my_table, padding = unit(1.5, "cm"), heights = c(.5, 1.5)), ncol = 2)
```


### Plot comparison
```{r, fig.width= 5, fig.height = 5}
auc_meta <- lapply(perf_obj_meta, function(x) return(x[[1]]))
auc_meta_bio <- lapply(perf_obj_biomarkers, function(x) return(x[[1]]))
auc_meta_null <- lapply(perf_obj_rand, function(x) return(x[[1]]))
auc_meta_null_set2 <- lapply(perf_obj_rand2, function(x) return(x[[1]]))
auc_meta_null_set3 <- lapply(perf_obj_rand3, function(x) return(x[[1]]))
df <- data.frame('meta' = unlist(auc_meta), 'meta_bio' = unlist(auc_meta_bio), 'meta_null' = unlist(auc_meta_null), 'meta_null_set2' = unlist(auc_meta_null_set2), 'meta_null_set3' = unlist(auc_meta_null_set3))
my_comparison <- list(c("meta", "meta_bio"), c("meta","meta_null"), c("meta_bio","meta_null"), c("meta_bio","meta_null_set2"), c("meta_bio","meta_null_set3"))
#, c("meta_null","meta_null_set2"), c("meta_null","meta_null_set3"), c("meta","meta_null_set2"), c("meta","meta_null_set3"), c("meta_null_set2","meta_null_set3"))
ggplot(melt(df), aes(x = variable, y = value, color = variable)) + geom_boxplot() + geom_jitter(width = .2) + theme_bw() +stat_compare_means(comparisons = my_comparison, label = "p.signif", hide.ns = TRUE)+labs(title="Random Forest Model AUC value Comparison",x ="Predictors Used", y = "AUC", color = "Predictors Used")

#ns: p > 0.05
#*: p <= 0.05
#**: p <= 0.01
#***: p <= 0.001
#****: p <= 0.0001

```

### bio, meta, null, stats
```{r}
summary(biodf$value)
summary(metadf$value)
summary(nulldf$value)
```
# Other models not reported in paper for sake on being concise

### All significant taxa in timeseries without Lifestyle_Variables
```{r, fig.height = 3, fig.width=5}
set.seed(1)
perf_obj_allsig <- rand_forest(pred_sequences = rownames(sig_res), ps = ps_deseq, include_taxa = T, include_meta = F)
plotAUCs(perf_obj_allsig, 1, "All Sig Taxa timeseries without Lifestyle_Variables")
```

### Just in two or more timeseries and null equivalent
```{r fig.height = 3, fig.width=5}
set.seed(1)
use <- grepl(",", sig_res$method)
perf_obj_biomarkers <- rand_forest(pred_sequences = rownames(sig_res)[use], ps = ps_deseq, include_taxa = T, include_meta = F)
plotAUCs(perf_obj_biomarkers, 3, "Taxa selected two methods timeseries, no Lifestyle_Variables")

set.seed(1)
amt <- grepl(",", sig_res$method)
use <- sample(taxa_names(ps_deseq)[-which(taxa_names(ps_deseq) %in% rownames(sig_res))], length(rownames(sig_res)[amt]))
perf_obj_rand <- rand_forest(pred_sequences = use, ps = ps_deseq, include_taxa = T, include_meta = F)
plotAUCs(perf_obj_rand, 3, "15 randomly selected taxa, no Lifestyle_Variables")
```

### Lifestyle_Variables and taxa selected by at least one method in mixed effect model (i.e. timepoint in formula)
```{r fig.height = 3, fig.width=5}
perf_obj_0 <- rand_forest(pred_sequences = rownames(sig_res), ps = ps_deseq, include_taxa = T, include_meta = T)
plotAUCs(perf_obj_0, 2, 'Taxa selected one method timeseries and Lifestyle_Variables')
```

### Lifestyle_Variables and all taxa selected at any timepoint
```{r, fig.height = 3, fig.width=5}
perf_obj_2 <- rand_forest(pred_sequences = rownames(sig_res_all), ps = ps_deseq, include_taxa = T, include_meta = T)
plotAUCs(perf_obj_2, 4, "Taxa at any timepoint and Lifestyle_Variables")
```

### Lifestyle_Variables and all taxa selected at 2 or more timepoints
```{r, fig.height = 3, fig.width=5}
use <- str_count(sig_res_all$enrichment, "Aut") >= 4
perf_obj_2 <- rand_forest(pred_sequences = rownames(sig_res_all), ps = ps_deseq, include_taxa = T, include_meta = T)
plotAUCs(perf_obj_2, 4, "Taxa 4 or more timepoints and Lifestyle_Variables")
```




### Taxa in either timeseries without Lifestyle_Variables
```{r, fig.height = 3, fig.width=5}
#use <- !is.na(sig_res$deseq_timeseries_adjp) | !is.na(sig_res$mtgseq_timeseries_adjp)
#sig_res has no "deseq_timeseries_adj" column or mtgseq one, will do work around
#since sig_res is only consisted of ones in either time series, should be okay to use all
perf_obj_allsig <- rand_forest(pred_sequences = rownames(sig_res), ps = ps_deseq, include_taxa = T, include_meta = F)
plotAUCs(perf_obj_allsig, 2, "All Sig Taxa")
```



### Variance in phenotype explained by most informative taxa by logistic regression
```{r}
runLogisticRegression <- function(pred_sequences, ps){
  set.seed(1)
  ps <- prune_taxa(pred_sequences, ps )
  folds_by_family <- groupKFold(ps@sam_data$familyID, 5)
  train <- t(ps@otu_table[, -folds_by_family[[1]]])
  test <- t(ps@otu_table[, folds_by_family[[1]]])
  train_y <- ps@sam_data$phenotype[-folds_by_family[[1]]]
  test_y <- ps@sam_data$phenotype[folds_by_family[[1]]]
  cvfit <- cv.glmnet(as.matrix(train), train_y, family = "binomial")
  preds <- predict(cvfit, test, s = 'lambda.min')
  pred.obj <- prediction(preds, test_y)
      
    #roc (tpr / fpr) perforamnce 
  roc_perf <- performance(pred.obj,"tpr", "fpr") #Calculate the AUC value
  auc_roc <- performance(pred.obj, "auc")@y.values[[1]]
  print(auc_roc)
}


```

```{r}
runLogisticRegression(taxa_names(ps_deseq), ps_deseq)
```

```{r}
use <- as.numeric(apply(sig_res, 1, function(x) return(sum(!is.na(x))))) > 0
runLogisticRegression(rownames(sig_res)[use], ps_deseq)
```

```{r}
use <- as.numeric(apply(sig_res, 1, function(x) return(sum(!is.na(x))))) > 1
runLogisticRegression(rownames(sig_res)[use], ps_deseq)
```

```{r}
#Similar issues to 266, will use weird workaround
#use <- !is.na(sig_res$deseq_timeseries_adjp) & !is.na(sig_res$mtgseq_timeseries_adjp)
use <- sig_res$method  %in% c("DESEQ_time" , "ZIG_time" , "ANCOM_time") == FALSE
runLogisticRegression(rownames(sig_res)[use], ps_deseq)
```
```{r}
#use <- !is.na(sig_res$deseq_timeseries_adjp) | !is.na(sig_res$mtgseq_timeseries_adjp)
#since sig_res is only consisted of ones in either time series, should be okay to use all
#Similar issues to 266, will use weird workaround

runLogisticRegression(rownames(sig_res), ps_deseq)
```


### Stool frequency
```{r fig.height = 3, fig.width=3}
aut <- ps_deseq@sam_data$phenotype == "A"
nt <- ps_deseq@sam_data$phenotype == "N"
boxplot(ps_deseq@sam_data$stool_freq[aut], ps_deseq@sam_data$stool_freq[nt])
```


### Heat Map
```{r heat map, fig.height = 10}
ps_tss <- readRDS("../results/Normalized/ps_tss_pass_min_postDD_min0.03.rds")
# Heatmap EXPERIMENTAL STAGE
heatmap <- ps_tss@otu_table[rownames(sig_res),]
heatlabel <- gsub("g__","",sig_res$Genus)
for (x in 1:70){
  if (heatlabel[x] == "unclassified"){
    heatlabel[x]<-paste(gsub("c__", "", sig_res$Class[x]), heatlabel[x], sep = "_")
  }
  heatlabel[x] <- paste(heatlabel[x], x, sep = ".")
}

rownames(heatmap) <- heatlabel
heatmap<-as.data.frame(heatmap)
heatmap <- t(heatmap)
heatmap<-as.data.frame(heatmap)
heatmap$Sample <- rownames(heatmap)
heatmap$Phenotype <- ps_tss@sam_data$phenotype
heatmap_below0.5 <- heatmap
maxes<-list()
for (x in c(1:70)){
   maxes[x]<-max(heatmap_below0.5[,x])
}
heatmap_below0.5 <- heatmap[,-which(maxes >= 0.002)]

heatmelt <-melt(heatmap_below0.5, value.name = "Abundance")
ggplot(heatmelt, aes(Sample, variable, fill= Abundance)) + 
  geom_tile() + 
  facet_grid(~ Phenotype,switch = "x", scales = "free_x", space = "free_x") +
  scale_fill_gradient(name = "Abundance",
                      low = "#FFFFFF",
                      high = "#012345")
confound_res <- read.csv("../results/significant_taxa_timeseries_confounders.csv")
use <- grepl(",", confound_res$method)
saveit<-confound_res[use,]
write.csv(saveit, "../confoundres_11.csv")

```