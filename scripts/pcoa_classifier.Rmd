---
title: "pcoa_classifier"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#setwd("~/Tree_M3_datasets/M3_Phyloseq_Analysis_breastfedout//scripts/")
library(caret)
library(randomForest)
library(tibble)
library(ROCR)
library(dplyr)
library(reshape2)
library(phyloseq)
library(glmnet)
library(stringr)
library(ggpubr)
library(grid)
library(gridExtra)
library(ggplot2)
library(pROC)
library(e1071)
library(dominanceanalysis)
source('../clean_mapping_ml.R')
```

# Load data
```{r}
output_data <- "../results/"
ps_not_norm_comp <- readRDS("../data/ps_not_norm_age_filter_complete_family.rds")
ps_deseq <- readRDS(paste0(output_data, "Filtered/ps_deseq_friedfilt.rds"))
ps_css <- readRDS(paste0(output_data, "Filtered/ps_css_friedfilt.rds"))
sig_res <- read.table(paste0(output_data, "significant_taxa_timeseries.tsv"), row.names = 1, sep = "\t", header = T)
sig_res_all <- read.table(paste0(output_data, "significant_taxa_all.tsv"), row.names = 1, sep = "\t", header = T)
```

### Will remake DESeq2 sam_data for the following code to work (Lifestyle_Variables formatting was changed in norm obj, and this obj isnt compatible with current code unless following chunk is used)

```{r}
ps_not_norm_comp <- readRDS("../data/ps_not_norm_age_filter_complete_family.rds")

#Remove Breastfed and their families
breast_fed <- c("089_A","054_N", "158_N" )

b_fed<-unique(ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Host.Name %in% breast_fed)])

#remove the whole family
for (i in b_fed){
  ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != i, ps_not_norm_comp)

}


#Remove Possible Contradictions and their families
possible_phen_contra <- c("020_A","131_A", "184_A" )

p_con<-unique(ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Host.Name %in% possible_phen_contra)])

#remove the whole family
for (i in p_con){
  ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != i, ps_not_norm_comp)

}

ps_deseq@sam_data<-sample_data(ps_not_norm_comp)

```



#PCoA constrained by multiple lifestyle variables
```{r}
sig_permanova <- read.csv("~/Lab/M3_Phyloseq_Analysis/results/sig_permanova.csv")
variables <- sig_permanova$Variable
behaviors <- c("Repetitive.motion", "Imitation.behavior", "Picks.up.objects.to.show.to.others", "Plays.in.a.group.with.others", "Language.ability.and.use", "Childhood.behavioral.development.finding", "Sleep.pattern.finding", "Gastrointestinal.problems..M3.")
silly <- c("Number.of.pet.reptiles", "Other.GI.symptoms..M3.", "GI.symptoms.within.3.months..M3.",
           "GI.issues.two.weeks.ago..M3.") #I'm removing the redundant GI symptoms because all parents answered yes to all GI questions all the time if they answered yes at all
variables <- variables[!(variables %in% behaviors)]
variables <- variables[!(variables %in% silly)]
variables

ps_use <- ps_deseq
df <- ps_deseq@sam_data[ , variables]
colnames(df) <- c("outdoor_pets", "nonceliac_gluten_sensitivity", "pets_in_home", "fruit", "seafood", "toilet_trained", "dairy_freq", "lactose_intolerance", "dietary_restrictions", "veg_freq", "dietary_supplement", "multivitamin", "sugary_food", "fermented_veg", "GI_issues_this_week", "vitamin_B", "meats_seafood_freq", "recent_anxiety")


handleNAs <- function(vec){
  vec[vec == ""] <- "NA"
  vec[is.na(vec)] <- "NA"
  return(vec)
}
 
 
convertFrequencyFreq <- function(map, variables){
  freq_dict_1 <- list("Never or less than once per week" = 0, "3-4 meals per week" = 1, "5" = 2, "7-10 meals per week" = 3, "Almost every meal" = 4, "NA" = NA)
  for(item in variables){
    print(item)
    tmp <- rep(NA, nrow(map))
    freqs <- unlist(handleNAs(map[ , item]))
    numeric_rep <- unlist(freq_dict_1[freqs])
    print(paste("Numeric rep length: ", length(numeric_rep)))
    print(sum(!is.na(freqs)))
    tmp[!is.na(freqs)] <- as.numeric(numeric_rep)  
    map[ , item] <- tmp
  }
  return(map)
}

convertFrequency <- function(map, variables){
    freq_dict_2 <- list("Never" = 0, "Rarely" = 1, "Occasionally" = 2, "Regularly" = 3, "Weekly" = 4,
                      "Several time weekly" = 5, "Several times weekly" = 5, "Daily" = 6, "NA" = NA)
 
  for(item in variables){
    print(item)
    tmp <- rep(NA, nrow(map))
    freqs <- unlist(handleNAs(map[,item]))
    numeric_rep <- unlist(freq_dict_2[freqs])
    print(paste("Numeric rep length: ", length(numeric_rep)))
    print(sum(!is.na(freqs)))
    tmp[!is.na(freqs)] <- as.numeric(numeric_rep)  
    map[ , item] <- tmp
  }
    return(map)
}

df <- convertFrequency(df, c("fruit", "seafood", "sugary_food", "fermented_veg", "vitamin_B"))
df <- convertFrequencyFreq(df, c("dairy_freq", "veg_freq", "meats_seafood_freq"))
df$recent_anxiety[df$recent_anxiety == "No elevated anxiety"] = 0
df$recent_anxiety[df$recent_anxiety == "Somewhat elevated anxiety"] = 1
df$recent_anxiety[df$recent_anxiety == "Elevated anxiety"] = 3
df$recent_anxiety <- as.numeric(df$recent_anxiety)

```


### Lifestyle_Variables for ML
```{r echo = F, results = 'hide'}

map_keep <- keepImportantColumns(ps_deseq@sam_data, metabol = F)
rownames(map_keep) <- map_keep$biospecimen_id
write.csv(map_keep, file = "../data/map_keep.csv")
map_keep<-read.csv(file = "../data/map_keep.csv", row.names = "X")

#Added makeFieldNumeric already in the filtering_normalization.rmd, so not needed here, so will omit
map_num <- makeFieldsNumeric(map_keep)
#select doesnt work for my session for some reason
#map_num <-map_num %>% select(-c(MARA, date))
map_num <- map_num[,-which(colnames(map_num) %in% c("MARA", "date"))]
nums <- as.vector(unlist(lapply(map_num, is.numeric)) )
map_num[, !nums] <- lapply(map_num[, !nums], factor)
map_num$stool_freq <- as.numeric(map_num$stool_freq)


```

```{r}
df <- df[ , !(colnames(df) %in% colnames(map_num))]
tmp <- cbind(map_num, df)
sample_data(ps_deseq) <- tmp

variables_permanova <- colnames(df)
```

#Processing
```{r}
getProcessedData <- function(ps){
  data <- data.frame(ps@sam_data)
  biospecimen_name <- data$biospecimen_name
  rownames(data) <- biospecimen_name
  host_name <- data$host_name
  #data <- data[!duplicated(data$host_name), ]
  data <- data %>% select(-c("biospecimen_id", "biospecimen_name", "host_name", "timepoint", "racial_group", "specific_food_allergy", "other_GI_symptoms", "diarrhea"))
  tmp <- data
  for(var in colnames(tmp)){
    if(c("TRUE") %in% tmp[,var]){
      tmp[,var] <- ifelse(tmp[,var]=="TRUE", 1, 0 )
    }
  }
  data <- tmp
  familyID <- data$familyID
  phenotype <- data$phenotype
  phenotype <- ifelse(phenotype == "A", 1, 0)
  
  data <- data %>% select(-c("phenotype", "familyID"))
  
  #normalize
  data <- data.frame(apply(data, 2, function(x){ return((x - mean(x, na.rm = T)) / sd(x, na.rm = T))}))
  data_use <- data.frame(cbind(data, phenotype, familyID))
  
  
  variables <- c("min_time_antibiotics", "stool_freq", "csection", "GI_issues_this_week", "gluten_allergy", "nonceliac_sensitivity", "whole_grain", "fermented_vegetables", "dairy", "fruit", "meal_home_prep", "meal_ready_eat", "meat", "olive_oil", "seafood", "sweetened_drink", "vegetable", "restaurant", "sugary_food", "infant_diet", "lactose_intolerance", "multivitamin", "prematurely_born", "probiotic", "dietary_supplement", "vitamin_B", "vitamin_D", "starchy_food", "meats_and_seafood", "bread", "dairy_freq", "fat_oil_freq", "vegetable_freq", "fruit_freq", "father_age", "mother_age", "recently_ill", "outdoor_pets", "recent_anxiety")
  x <- as.matrix(data_use[ , variables])
  keep <- apply(x, 1, function(x) return(sum(is.na(x)))) < 1
  
  
  data_use <- data_use[keep, ]
  
  
  #use embedding as micro features
  #embedded <- read.csv("~/Lab/M3_Phyloseq_Analysis/results/embedding/embedded.csv", row.names = 1)
  #keep <- intersect(rownames(data_use), rownames(embedded))
  #micro_features <- embedded[keep, ]
  #data_use <- data_use[keep, ]
  
  #use ordination as microfeaturs
  ord <- ordinate(ps, method = "PCoA", distance = "bray")
  micro_features <- ord$vectors[keep, ]
  micro_features <- data.frame(apply(micro_features, 2, function(x){ return((x - mean(x, na.rm = T)) / sd(x, na.rm = T))}))
  
  data_use <- data.frame(data_use, micro_features)
  return(data_use)
}

```

```{r}
library(caret)
getAUC <- function(x, y, data_use, model = F, seed = 4, null = F){
  x = data.frame(x)
  if(null){
    random_noise_x <- apply(x, 2, function(vec){
      random_vec <- runif(n = nrow(x), min = min(vec), max(vec))
      make_zero <- rbinom(n = length(vec), size = 1, prob = sum(vec == 0) / length(vec))
      vec[make_zero] = 0
      return(random_vec)
    })
    x <- random_noise_x
  }
 
  m <- cv.glmnet(x = as.matrix(x), y = y, type.measure="auc" , family = "binomial", seed = seed, nfolds = 4)
  lambda_opt=m$lambda.min
  if(model){
      f <- paste("phenotype ~ ", paste(colnames(x), collapse = "+"))
      df <- data.frame(x)
      df$phenotype <- y
      fit <- glm(formula = f, data = df, family = "binomial")
    return(fit)
  }

  #probs <- predict(m, newx = as.matrix(x), type = "response", s = lambda_opt)
  #data_use$probs <- probs
  #roc_res = roc(response = as.numeric(data_use$phenotype), predictor = as.numeric(data_use$probs))
  avg_crossval_error <- m$cvm[m$lambda == m$lambda.min]
  avg_crossval_performance <- 1 - avg_crossval_error
  return(avg_crossval_error)
}
```



#Basic model: age, gender
```{r}
library(pROC)
#f <- "phenotype ~ age + sex"
getBasicModel <- function(data_use, null = F){
  y <- data_use$phenotype
  x <- as.matrix(data_use[ , c("sex", "age")])
  basic_aucs <- c()
  for(i in seq(1, iter)){
    basic_auc <- getAUC(x, y, data_use, null = null, seed = i)
    print(basic_auc)
    basic_aucs <- c(basic_aucs, basic_auc)
  }

  return(basic_aucs)
}

```

#metadata model: basic + all other metadata variables
```{r}
getMetadataModel <- function(data_use, variables, null = F){
  y <- data_use$phenotype
  x <- as.matrix(data_use[ , c("sex", "age", variables)])
  
  metadata_aucs <- c()
  for(i in seq(1, iter)){
    basic_metadata_auc <- getAUC(x, y, data_use, null = null, seed = i)
    print(basic_metadata_auc)
    metadata_aucs <- c(metadata_aucs, basic_metadata_auc)
  }

  return(metadata_aucs)
}

```

#microbiome model: basic + pcoa microbiome
```{r}
getMicrobiomeModel <- function(data_use, micro_features, null = F){
  y = data_use$phenotype
  x = data.frame(data_use[ , c("age", "sex", micro_features)])
  
  micro_aucs <- c()
  for(i in seq(1,iter)){
    basic_micro_auc <- getAUC(x = as.matrix(x), y=y, data_use = data_use, null = null, seed = i)
    print(basic_micro_auc)
    micro_aucs <- c(micro_aucs, basic_micro_auc)
  }

  return(micro_aucs)
}

```

#Combo model: basic + pcoa microbiome + metadata variables
```{r}
getComboModel <- function(data_use, null = F){
  y = data_use$phenotype
  x = data.frame(data_use[ , c("age", "sex", colnames(micro_features), variables)])
  
  combo_aucs <- c()
  for(i in seq(1,iter)){
    basic_metadata_micro <- getAUC(x, y, data_use, null = null, seed = i)
    print(basic_metadata_micro)
    combo_aucs <- c(combo_aucs, basic_metadata_micro)
  }
  
  return(combo_aucs)
}

```


```{r}
#embedded <- read.csv("~/Lab/M3_Phyloseq_Analysis/results/embedding/embedded.csv", row.names = 1)
#micro_features <- embedded[data$biospecimen_name, ]
iter = 3
data_use <- getProcessedData(ps_deseq)

ord <- ordinate(ps_deseq, method = "PCoA", distance = "bray")
micro_features <- colnames(ord$vectors)[1:50]

variables <- c("min_time_antibiotics", "stool_freq", "csection", "GI_issues_this_week", "gluten_allergy", "nonceliac_sensitivity", "whole_grain", "fermented_vegetables", "dairy", "fruit", "meal_home_prep", "meal_ready_eat", "meat", "olive_oil", "seafood", "sweetened_drink", "vegetable", "restaurant", "sugary_food", "infant_diet", "lactose_intolerance", "multivitamin", "prematurely_born", "probiotic", "dietary_supplement", "vitamin_B", "vitamin_D", "starchy_food", "meats_and_seafood", "bread", "dairy_freq", "fat_oil_freq", "vegetable_freq", "fruit_freq", "father_age", "mother_age", "recently_ill", "outdoor_pets", "recent_anxiety")
  
  
data_time1 <- getProcessedData(prune_samples(ps_deseq@sam_data$timepoint == "Timepoint 1", ps_deseq))
data_time2 <- getProcessedData(prune_samples(ps_deseq@sam_data$timepoint == "Timepoint 2", ps_deseq))
data_time3 <- getProcessedData(prune_samples(ps_deseq@sam_data$timepoint == "Timepoint 3", ps_deseq))

df_1 <- data.frame(basic = getBasicModel(data_time1),
                 meta = getMetadataModel(data_time1, variables),
                 meta_null = getMetadataModel(data_time1, variables, null = T),
                 micro = getMicrobiomeModel(data_time1, micro_features),
                 micro_null = getMicrobiomeModel(data_time1, micro_features, null = T),
                 combo = getComboModel(data_time1)
                 )


df_2 <- data.frame(basic = getBasicModel(data_time2),
                 meta = getMetadataModel(data_time2, variables),
                 meta_null = getMetadataModel(data_time2, variables, null = T),
                 micro = getMicrobiomeModel(data_time2, micro_features),
                 micro_null = getMicrobiomeModel(data_time2, micro_features, null = T),
                 combo = getComboModel(data_time2)
                 )


df_3 <- data.frame(basic = getBasicModel(data_time3),
                 meta = getMetadataModel(data_time3, variables),
                 meta_null = getMetadataModel(data_time3, variables, null = T),
                 micro = getMicrobiomeModel(data_time3, micro_features),
                 micro_null = getMicrobiomeModel(data_time3, micro_features, null = T),
                 combo = getComboModel(data_time3)
                 )
df <- rbind(df_1, df_2, df_3)
df <- melt(df)

comp <- list(c('basic', 'meta'), c('basic', 'meta_null'), c('basic', 'micro'), c('basic', 'micro_null'), c('basic', 'combo'),
             c('micro', 'micro_null'), c('meta', 'combo'))

p <- ggplot(df, aes(x = variable, y = value, fill = variable)) + geom_boxplot() + geom_jitter(width = 0)+
  stat_compare_means(comparisons = comp, label = "p.format", hide.ns = FALSE, method = "wilcox.test", size = 3, paired = TRUE) + ylab("Cross-Validated performance") + ylim(c(0.4, 1.21)) + theme(text = element_text(size=20), axis.text.x = element_text(angle=90, hjust = 0.95, vjust = 0.2), axis.title.x = element_blank(), axis.title.y = element_text(size = 15))
p

#data <- summarize(group_by(df, variable), mean = mean(value), sd = sd(value))
#p <- ggplot(data, aes(x = variable, y = mean, fill = variable)) + geom_bar(stat = "identity") + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.1) + ylim(0,1) + theme_minimal() + ylab("Average AUC") + xlab("")

#t.test(df$value[df$variable == "basic"], df$value[df$variable == "meta"])
#t.test(df$value[df$variable == "basic"], df$value[df$variable == "meta_null"])
#t.test(df$value[df$variable == "basic"], df$value[df$variable == "micro"])
#t.test(df$value[df$variable == "basic"], df$value[df$variable == "micro_null"])
#t.test(df$value[df$variable == "meta"], df$value[df$variable == "combo"])
#t.test(df$value[df$variable == "meta"], df$value[df$variable == "meta_null"])
#t.test(df$value[df$variable == "micro"], df$value[df$variable == "micro_null"])
p
ggsave("../results/summarize_effects/effect_per_feature_set.png", p, width = 5, height = 4)
ggsave("../results/summarize_effects/effect_per_feature_set.pdf", p, width = 5, height = 4)

```


```{r}
data_use <- getProcessedData(ps_deseq)
```

#Importances
```{r}

#Metadata
y <- data_use$phenotype
x <- as.matrix(data_use[ , c("sex", "age", variables)])
metadata <- getAUC(x, y, data_use, model = T, seed = 4)
#summary(metadata)

data <- summary(metadata)$coefficients
data <- data[order(data[, 4]), ]
variables_use <- rownames(data)[data[ , 4] < 0.25]

y = data_use$phenotype
x = data.frame(data_use[ , c("age", "sex", micro_features)])
micro <- getAUC(x = x, y = y, data_use = data_use, model = T, seed = 4)
#summary(micro)
data <- summary(micro)$coefficients
data <- data[order(data[, 4]), ]
micro_use <- rownames(data)[data[ , 4] < 0.15]

y = data_use$phenotype
x = data.frame(data_use[ , c("age", "sex", variables_use, micro_use)])
getAUC(x = x, y = y, data_use = data_use, model = F)
combo <- getAUC(x = x, y = y, data_use = data_use, model = T)
#summary(combo)

data <- summary(combo)$coefficients
data <- data[order(data[, 4]), ]
data

```

#Lifestyle variables related to autism
```{r}
library(DT)

# We got data from a combination model

data <- summary(metadata)$coefficients
data <- data[order(data[, 4]), ]

df <- round(data[data[,4] < .07,  ], 3)
colnames(df) <- c("Estimate", "Standard Error", "Z value", "P value")
datatable(df)

write.csv(df, "../results/summarize_effects/lifestyle_variables_important.csv",  row.names = T, quote = F)

```

# Correlation between lifestyle variables
```{r, fig.width = 15, fig. height = 20}
library(pheatmap)
library(colorspace)
metadata_df <- data_use[ , c("sex", "age", variables)]


colfunc <- colorRampPalette(c( "#84CF04", "#e5e5e5", "#01B5BB" ))
#colfunc <- colorRampPalette(c("#177E89", "#e5e5e5", "#73B404" ))
#colfunc <- colorRampPalette(c("#006D77", "#83C5BE", "#EDF6F9", "#FFDDD2", "#E29578"))
col_vals <- colfunc(30)


df_annotation <- data.frame(association_asd = summary(metadata)$coefficients[,3])

colors_use <- list(association_asd  = col_vals)
cor_df <- cor(metadata_df, method = "spearman")
diag(cor_df) = NA

imp_variables <- rownames(df)[df[,4] < .05]
cor_df <- cor_df[, imp_variables]

p <- pheatmap(cor_df, fontsize = 10, annotation_col = df_annotation, annotation_row = df_annotation, annotation_colors = colors_use, color = diverge_hcl(n = 20, alpha = 0.7))

p
ggsave("../results/summarize_effects/metadata_correlation_asd_annotated.png", p, width = 7, height = 11)
ggsave("../results/summarize_effects/metadata_correlation_asd_annotated.tiff", p, width = 7, height = 11)
ggsave("../results/summarize_effects/metadata_correlation_asd_annotated.pdf", p, width = 7, height = 11)
```

# Correlation between principal components and lifestyle variables
```{r}
data <- data_use[ , c(variables, micro_use)]
cor_mat <- cor(data, method = "spearman")
cor_mat <- cor_mat[variables, micro_use[!(micro_use %in% c('sex', 'age'))]]

df_annotation <- data.frame(association_asd = summary(micro)$coefficients[,3])

p <- pheatmap(cor_mat,  fontsize = 10, annotation_col = df_annotation, annotation_colors = colors_use, color = diverge_hcl(n = 20, alpha = 0.7))
p

ggsave("../results/summarize_effects/pcoa_axes_metadata_correlations_asd_annotations.png", p,  width = 7, height = 11)
ggsave("../results/summarize_effects/pcoa_axes_metadata_correlations_asd_annotations.pdf", p,  width = 7, height = 11)

```

```{r}
data <- summary(micro)$coefficients
data <- data[order(data[, 4]), ]

df <- round(data[data[,4] < .05,  ], 3)
colnames(df) <- c("Estimate", "Standard Error", "Z value", "P value")
df <- df[!(rownames(df) %in% c("sex", "age")), ]

datatable(df)

write.csv(df, "../results/summarize_effects/pcoa_variable_important.csv",  row.names = T, quote = F)


```


# gsea of biomarkers on axes
```{r}
ord <- ordinate(ps_deseq, method = "PCoA", distance = "bray")
pcoa <- ord$vectors[ , rownames(df)]
output_data <- "../results/"
sig_res <- read.table(paste0(output_data, "significant_taxa_timeseries.tsv"), row.names = 1, sep = "\t", header = T)
use <- grepl(",", sig_res$method)
biomarkers <- rownames(sig_res)[use]
asv_tab <- ps_deseq@otu_table
loadings <- asv_tab %*% pcoa
write.csv(loadings, "~/Lab/M3_Phyloseq_Analysis/results/summarize_effects/asv_loadings_pcoa.csv", quote = F)
write(biomarkers, "~/Lab/M3_Phyloseq_Analysis/results/summarize_effects/11_biomarkers.csv")

library(gage)
gene_set <- list(biomarkers = biomarkers)
tmp <- gage(loadings, gsets = gene_set)
```



