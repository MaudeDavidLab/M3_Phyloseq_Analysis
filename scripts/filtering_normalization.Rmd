---
title: "filtering_normalization"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(reshape2)
library(phyloseq)
library(rstatix)
library(pbapply)
library(metagenomeSeq)
library(DESeq2)
```
# Read raw data
```{r}
ps_not_norm_comp <- readRDS("../data/ps_not_norm_age_filter_complete_family.rds")
output_data = "../results/"
dir.create(paste0(output_data, 'Normalized/'))
```

# Normalization
```{r normalization}


#Filtering of the prevalence: 
###Declare function to filter
filterTaxaByPrevolence <- function(ps, percentSamplesPresentIn){
  prevalenceThreshold <- percentSamplesPresentIn * nsamples(ps)
  toKeep <- apply(data.frame(otu_table(ps)), 1, function(taxa) return(sum(taxa > 0) > prevalenceThreshold))
  ps_filt <- prune_taxa(toKeep, ps)
  return(ps_filt)
}

#CSS norm function
#We actually will plot everything with CSS 
CSS_norm<-function(ps){
  ps.metaG<-phyloseq_to_metagenomeSeq(ps)
  p_stat = cumNormStatFast(ps.metaG)
  ps.metaG = cumNorm(ps.metaG, p = p_stat)
  ps.metaG.norm <- MRcounts(ps.metaG, norm = T)
  ps_CSS<-phyloseq(otu_table(ps.metaG.norm, taxa_are_rows = T), sample_data(ps),tax_table(ps))
  return(ps_CSS)
}

#Deseq norm 
deSeqNorm <- function(ps){
  ps_dds <- phyloseq_to_deseq2(ps, ~ phenotype + Family.group.ID)
  ps_dds <- estimateSizeFactors(ps_dds, type = "poscounts")
  ps_dds <- estimateDispersions(ps_dds)
  abund <- getVarianceStabilizedData(ps_dds)
  abund <- abund + abs(min(abund)) #don't allow deseq to return negative counts
  ps_deSeq <- phyloseq(otu_table(abund, taxa_are_rows = T), sample_data(ps), tax_table(ps))
  return(ps_deSeq)
}

#remove samples that are too young and their paired sibling
tooyoung <-ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Age..months. < 24)]

#family 65 should be removed according to >24 months criteria
ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != unique(tooyoung), ps_not_norm_comp)

#List of individuals that were reported w/ autism, but was not classified as such through MARA and/or video classifier
pheno_contrad <-read.csv("../phenotype_contradictions.csv")
contradicting<-unique(ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Host.Name %in% as.character(pheno_contrad$host_name))])

#remove the whole family
for (i in contradicting){
  ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != i, ps_not_norm_comp)

}

#Remove Breastfed and their families
breast_fed <- c("089_A","054_N", "158_N" )

b_fed<-unique(ps_not_norm_comp@sam_data$Family.group.ID[which(ps_not_norm_comp@sam_data$Host.Name %in% breast_fed)])

#remove the whole family
for (i in b_fed){
  ps_not_norm_comp<- prune_samples(ps_not_norm_comp@sam_data$Family.group.ID != i, ps_not_norm_comp)

}


#Now we remove the taxa present in less than 3 % of the samples with some basic filtering 
filtered_ps003<-filterTaxaByPrevolence(ps_not_norm_comp, 0.03)
filtered_ps003
saveRDS(filtered_ps003, file=paste0(output_data, "Normalized/ps_not_norm_comp_pass_min_postDD_min0.03.rds"))

# CSS normalization
ps_css<- CSS_norm(filtered_ps003)
saveRDS(ps_css, file=paste0(output_data, "Normalized/ps_CSS_pass_min_postDD_min0.03.rds"))

# DESeq normalization
ps_deseq <- deSeqNorm(filtered_ps003)
saveRDS(ps_deseq, file=paste0(output_data, "Normalized/ps_DeSeq_pass_min_postDD_min0.03.rds"))

# TSS normalization
propDF=prop.table(as.matrix(otu_table(filtered_ps003)), margin=2)
ps_tss <- phyloseq(otu_table(propDF, taxa_are_rows=TRUE), 
                                               tax_table(filtered_ps003), 
                                               sample_data(filtered_ps003))
saveRDS(ps_tss, paste0(output_data, "Normalized/ps_tss_pass_min_postDD_min0.03.rds"))
```


```{r}
ps_deseq <- readRDS(paste0(output_data, "Normalized/ps_DeSeq_pass_min_postDD_min0.03.rds"))
ps_css <- readRDS(paste0(output_data, "Normalized/ps_CSS_pass_min_postDD_min0.03.rds"))
ps_no_norm <- readRDS(paste0(output_data, "Normalized/ps_not_norm_comp_pass_min_postDD_min0.03.rds"))

getASVsChangeSigOverTime <- function(ps){
  asv_table<-t(otu_table(ps))
  asv_table <- as.data.frame(asv_table)
  asv_table$timepoint <- ps@sam_data$Within.study.sampling.date
  asv_table$timepoint <- gsub(" ", "", asv_table$timepoint)
  asv_table$timepoint <- as.factor(asv_table$timepoint)
  asv_table$Host.Name <- ps@sam_data$Host.Name
  
  asv_long <- melt(asv_table, id = c("timepoint", "Host.Name"))
  change_over_timepoints_pvals <- pbsapply( unique(asv_long$variable), function(seq){
    asv_tmp <- asv_long[asv_long$variable == seq, ]
    asv_tmp <- select(asv_tmp, -c("variable"))
    res.fried <- asv_tmp %>% friedman_test(value ~ timepoint |Host.Name)
    return(res.fried$p)
  })
  asvs <- unique(asv_long$variable)[change_over_timepoints_pvals < .1]
  return(asvs)
}

#Set threshold for p value at .1 - If taxa are changing that much over 3 time points, their fluctuations are likely due to seasons or dietary
#changes rather than long standing gut-brain axis phenomenon
asv_deseq <- as.character(getASVsChangeSigOverTime(ps_deseq))
asv_css <- as.character(getASVsChangeSigOverTime(ps_css))
asv_intersect <- intersect(asv_deseq, asv_css)

#remove these taxa from phyloseqs (since they are noise essentially)
keep = taxa_names(ps_deseq)[!(taxa_names(ps_deseq) %in% asv_deseq)]
ps_deseq_filt <- prune_taxa(keep, ps_deseq)

keep = taxa_names(ps_css)[!(taxa_names(ps_css) %in% asv_css)]
ps_css_filt <- prune_taxa(keep, ps_css)

keep = taxa_names(ps_no_norm)[!(taxa_names(ps_no_norm) %in% asv_intersect)]
ps_no_norm_filt <- prune_taxa(keep, ps_no_norm)


dir.create(path = paste0(output_data, "Filtered"))
saveRDS(ps_deseq_filt, paste0(output_data, "Filtered/ps_deseq_friedfilt.rds"))
saveRDS(ps_css_filt, paste0(output_data, "Filtered/ps_css_friedfilt.rds"))
saveRDS(ps_no_norm_filt, paste0(output_data, "Filtered/ps_no_norm_friedfilt.rds"))
```