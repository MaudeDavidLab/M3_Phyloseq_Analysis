---
title: "confounders"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(vegan)
library(phyloseq)
library(gridExtra)
library(adegraphics)
```

### Load Data
```{r}
ps_deseq <- readRDS("Filtered/ps_deseq_friedfilt.rds")
map <- ps_deseq@sam_data
map_num<-sapply(map, is.numeric)
num_cat <- colnames(map[,as.vector(which(map_num == TRUE))])
num_cat <- num_cat[-c(1:4)]
num_cat <- num_cat[-which(num_cat %in% c("Language.ability.and.use", "Conversation.ability", "Understands.speech", "Number.of.small.pet.herbivores", "Number.of.small.pet.rodents", "phenotype_num", "Number.of.pet.birds"))]

fac_cat<-names(Filter(is.factor, map))
#removing the first 13 columns, since it's not metadata and the last one which is phenotype  
fac_cat<-fac_cat[-c(1:13, length(fac_cat))]
#finally removing the ones that were only asked for the children with ASD, or only have one factor & NA, or only present in one phen
fac_cat<-fac_cat[-which(fac_cat %in% c("Behavior.video.submitted..M3.","Language.ability.and.use","Conversation.ability","Understands.speech","Plays.imaginatively.when.alone","Plays.imaginatively.with.others","Plays.in.a.group.with.others","Eye.contact.finding","Childhood.behavioral.development.finding","Repetitive.motion","Picks.up.objects.to.show.to.others","Sleep.pattern.finding","Response.to.typical.sounds","Self.injurious.behavior.finding","Gastrointestinal.problems..M3.", "Imitation.behavior", "Other.stool.sample.collection.method.explained..M3.", "Flu.shot.in.the.last..MFlu.shot.in.the.last..M3.", "Pica.disease", "Additional.info.affecting.microbiome..M3.", "Dietary.restrictions.details..M3.", "Pet.bird"))]
                          
```

# PERMANOVA
non- parametric statistical approaches (ANOSIM, ADONIS, ANOVA, PERMANOVA, etc.) will be employed to determine the significance of noteworthy factors, such as digital phenotype, probiotic and/or antibiotic use

## PERMANOVA test
```{r permanova, results="asis"}
permanova <- function(physeq, factorName, ifnumeric, pmt = 999){
  set.seed(1)
  braydist = phyloseq::distance(physeq, "bray")
  form <- as.formula(paste("braydist ~ ", c(factorName), sep = ""))
  metaDF=data.frame(sample_data(physeq)[, as.character(factorName)])
  # if numerical variable, make sure the class
  if(ifnumeric){
    metaDF[, factorName] <- as.numeric(metaDF[, factorName])
    factor_class='numeric'
  } else {
    factor_class='categorical'
  }
  perm <- adonis(form, permutations = pmt, metaDF)
  permDT=data.table(Variable=factorName, 
             FactorClass=factor_class,
             TotalN=perm$aov.tab['Total','Df']+1, 
             R2=perm$aov.tab[factorName, 'R2'], 
             pvalue=perm$aov.tab[factorName,'Pr(>F)'][1])
  return(permDT)
}

#we keep only the cateory selected above as relevant 
tmp_metadata <- map[,c(num_cat,fac_cat)]
#For categorical variables, keep only those with 2 or more possible answers
cat_drop <- sapply(tmp_metadata[ , fac_cat], function(x) return(length(levels(x)) < 2))
fac_cat_drop <- fac_cat[cat_drop]
tmp_metadata <- tmp_metadata %>% select(-fac_cat_drop)
#For all variables, keep only those where at least 20% have valid answers
cols_keep <- as.vector(apply(tmp_metadata, 2, function(x) return(sum(is.na(x)) < length(x)*.8 )))
metadata <- tmp_metadata[ , cols_keep]


#Test the homogeneity of dispersion before running permanova - we only wish to test variables that are dispersed homogeneously with respect
#to the distances between samples in microbiome space
set.seed(1)
pval_factors_disper=c()
nb_samples_disper=c()
for (i in 1:ncol(metadata)){
  cat (i,"\t")
  #Drop samples that have NA for the specified variable
  test_map <- metadata[!is.na(metadata[,i]) & metadata[,i] != "" ,]
  ps_tmp <- ps_deseq
  sample_data(ps_tmp) <- test_map

  dist_bray <- phyloseq::distance(ps_tmp, method = "bray")
  beta <- betadisper(dist_bray, get_variable(ps_tmp)[, i])
  tmp <- permutest(beta)
  tmp <- tmp$tab$`Pr(>F)`[1]
  pval_factors_disper <- c(pval_factors_disper,tmp)
  nb_samples_disper <- c(nb_samples_disper, nsamples(ps_tmp))}
#correct the p.value 
names(pval_factors_disper) <- colnames(metadata)
pval_factors_disper <- p.adjust(pval_factors_disper, method = "fdr")
to_remove_betadis <- names(pval_factors_disper)[pval_factors_disper < 0.05]

permanova_df <- metadata %>% select(-to_remove_betadis)
set.seed(1)
permanova_res=NULL
for(var_name in colnames(permanova_df)){
  print(var_name)
  #Drop samples that have NA for the specified variable
  test_map <- permanova_df[!is.na(permanova_df[ , var_name]) & permanova_df[ , var_name] != "" , ]
  ps_tmp <- ps_deseq
  sample_data(ps_tmp) <- test_map
  
  # Check if there is more than 1 values (categories)
  if(uniqueN(ps_tmp@sam_data[ , var_name]) > 1){
    
    # if categorical
    if(is.factor(permanova_df[[var_name]])){
      # run permanova only if there are more than 1 groups
      p <- permanova(ps_tmp, factorName = var_name, ifnumeric = FALSE, pmt = 999)
      permanova_res=rbindlist(list(permanova_res, p))
      rm(p)
    }
    # if continuous
    if(is.numeric(permanova_df[[var_name]])){
      p <- permanova(ps_tmp, factorName = var_name, ifnumeric = TRUE, pmt = 999)
      permanova_res=rbindlist(list(permanova_res, p))
      rm(p)
    }
  }
  rm(var_name)
}


#removing LR predictions since those are essentially an indicator of phenotype and not confounding variables
permanova_res<-permanova_res[-which(permanova_res$Variable %in% c("LR10.probability.ASD..M3..1", "LR5.probability.ASD..M3..1", "LR6.probability.ASD..M3..1" , "LR10.prediction..M3..1", "LR10.probability.not.ASD..M3..1", "LR5.probability.not.ASD..M3..1" , "LR5.prediction..M3..1", "LR6.prediction..M3..1" , "LR6.probability.not.ASD..M3..1")), ]

# sort
permanova_res <- permanova_res[order(R2, decreasing=TRUE)]
datatable(permanova_res)
write.csv(permanova_res, file=paste0('PERMANOV_noLR.csv'), row.names=FALSE)

```



## Visualize permanova significant variables on PCoA
```{r plot_R2_value, fig.width=16, fig.height=40}
# function to plot PCoA, only for higher R2 value 
imp_factors<-permanova_res$Variable[permanova_res$R2 > 0.009]
imp_factors <- gsub(".1","", imp_factors)

#Drop factors that have too many NA values
keep_factors <- imp_factors[apply(map[, imp_factors], 2 ,function(x) return(sum(is.na(x)) < 30))]
#Drop samples that have NA for any of the factors of interest
map_plot <- map[ , keep_factors]
map_plot <- map_plot[complete.cases(map_plot), ]

ps_deseq_pcoa <- ps_deseq
sample_data(ps_deseq_pcoa) <- map_plot
f <- as.formula(paste0("~", paste0(colnames(map_plot), collapse = "+")))

#ordination formula .
ord_pcoa <- ordinate(
  physeq = ps_deseq_pcoa, 
  method = "CAP", 
  distance = "bray",
  formula = f)

title_prep <- colnames(map_plot)
to_plot=list()
for (i in 1:length(title_prep)){
  to_plot[[i]] <- plot_ordination(
  physeq = ps_deseq, 
  ordination = ord_pcoa, 
  color = title_prep[i], 
  axes = c(1,2),
  title=title_prep[i]
) + 
  geom_point( size = 0.5) +
  theme(text = element_text(size =20), plot.title = element_text(size=15))
}
to_plot[[length(title_prep)+1]] <- plot_ordination(physeq = ps_deseq, ordination = ord_pcoa, type="taxa",title ="Taxa") + theme(text = element_text(size =15))
lay <- rbind(c(1),
             c(2),
             c(3),
             c(4),
             c(5),
             c(6),
             c(7),
             c(8),
             c(9),
             c(10),
             c(11))


#pdf(paste0(output_data,"confounding_factors.pdf",width=16,height=40))
grid.arrange(grobs = as.list(to_plot), layout_matrix = lay)
top_potential_confounds <- imp_factors
top_potential_confounds


GI_problem_plo <- plot_ordination(
physeq = ps_deseq, 
ordination = ps_pcoa, 
color = "Most.recent.GI.episode.symptoms..M3.", 
axes = c(1,2),
title=title_prep[i] + 
geom_point( size = 0.5) +
theme(text = element_text(size =20), plot.title = element_text(size=15)))


#dev.off()
```

```{r plot_imp_taxa}
#Let's have a look at the plot 
plot_ordination(physeq = ps_deseq, ordination = ord_pcoa, type="taxa",title ="Taxa") + theme(text = element_text(size =8))
#ok let's try to find the spcies that show some importance in this PCA
taxa.to.select<-vegan::scores(ord_pcoa)$species
#now plot it with no name for visibilty
rownames(taxa.to.select)<-c()
s.arrow(taxa.to.select) #the taxa that influence the most the plots are above 0.1
taxa.to.select.to.rem<-vegan::scores(ord_pcoa)$species[abs(vegan::scores(ord_pcoa)$species[,1])>0.1 | abs(vegan::scores(ps_pcoa)$species[,2])>0.1,]

#any overlap with the 5 important? 
deseq_res <- readRDS("DESeq/full_res_table_deseq")
rownames(deseq_res) %in% taxa.to.select.to.rem #NOPE!

saveRDS(taxa.to.select.to.rem, "taxa_associated_confounding_variables.rds")
```