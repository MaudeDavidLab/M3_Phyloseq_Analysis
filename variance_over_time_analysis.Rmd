---
title: "variance_over_time_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(reshape2)
library(permute)
```

# Load data
```{r}
ps_deseq <- readRDS("Filtered/ps_deseq_friedfilt.rds")
ps_deseq@sam_data$Within.study.sampling.date <- gsub(" ", "", ps_deseq@sam_data$Within.study.sampling.date)
```

## Comparison of Variance between Subjects and between Phenotypes
```{r variance}
dist = "horn"
getIndDist_onefamily <- function(psA, psN, fam_id, dist){
  A <- distance(psA, dist, type = "samples")
  ave_distanceA=ave(c(A[1],A[2],A[3]))[1]
  
  N <- distance(psN, dist, type = "samples")
  ave_distanceN=ave(c(N[1],N[2],N[3]))[1]
  
  tab <- tibble(ave_distanceA, ave_distanceN, fam_id)
  colnames(tab) <- c("AvgDistanceAut", "AvgDistanceNeu", "family")
  return(tab)
}

#Comparing variance w/ avg difference in distance
tmpps <- prune_samples((ps_deseq@sam_data$family.group.ID == "1"), ps_deseq)
psA <- prune_samples(tmpps@sam_data$phenotype == "A", tmpps)
psN <- prune_samples(tmpps@sam_data$phenotype == "N", tmpps)
tab <- getIndDist_onefamily(psA, psN, "1", dist)
for(i in unique(ps_deseq@sam_data$family.group.ID)){
  tmpps <- prune_samples((ps_deseq@sam_data$family.group.ID == i), ps_deseq)
  psA <- prune_samples(tmpps@sam_data$phenotype == "A", tmpps)
  psN <- prune_samples(tmpps@sam_data$phenotype == "N", tmpps)
  
  tab_tmp <- getIndDist_onefamily(psA, psN, i, dist)
  tab<-rbind(tab, tab_tmp)
}


#plot
p <- ggplot(melt(tab), aes(x=variable, y=value)) + 
  geom_boxplot()
p + geom_jitter(shape=16, position=position_jitter(0.2))

# run tests to check significance
shapiro.test(c(tab$AvgDistanceAut, tab$AvgDistanceNeu)) #not normal we need a reanking test
wilcox.test(tab$AvgDistanceAut, tab$AvgDistanceNeu, paired = T)
```

```{r}
dist = 'horn'
getIndDist_onefamily_timepoint<- function(psA, psN, fam_id, dist = "bray"){
  A <- as.matrix(distance(psA, dist, type = "samples"), labels = T)
  colnames(A) <- psA@sam_data[rownames(A), ]$Within.study.sampling.date
  rownames(A) <- psA@sam_data[rownames(A), ]$Within.study.sampling.date
  distanceA <- c(A["Timepoint1", "Timepoint2"], A["Timepoint1", "Timepoint3"], A["Timepoint2", "Timepoint3"])
  
  N <- as.matrix(distance(psN, dist, type = "samples"), labels = T)
  colnames(N) <- psN@sam_data[rownames(N), ]$Within.study.sampling.date
  rownames(N) <- psN@sam_data[rownames(N), ]$Within.study.sampling.date
  distanceN <- c(N["Timepoint1", "Timepoint2"], N["Timepoint1", "Timepoint3"], N["Timepoint2", "Timepoint3"])
  
  tab <- tibble(distanceA, distanceN, rep(fam_id, length(distanceA)), c("Timepoint 1-2", "Timepoint 1-3", "Timepoint 2-3"))
  colnames(tab) <- c("DistanceAut", "DistanceNeu", "family", "Timepoint")
  return(tab)
}
tmpps <- prune_samples((ps_deseq@sam_data$family.group.ID == "1"), ps_deseq)
psA <- prune_samples(tmpps@sam_data$phenotype == "A", tmpps)
psN <- prune_samples(tmpps@sam_data$phenotype == "N", tmpps)
tab <- getIndDist_onefamily_timepoint(psA, psN, "1", dist)

for(i in unique(ps_deseq@sam_data$family.group.ID)[c(-1)]){
  tmpps <- prune_samples((ps_deseq@sam_data$family.group.ID == i), ps_deseq)
  psA <- prune_samples(tmpps@sam_data$phenotype == "A", tmpps)
  psN <- prune_samples(tmpps@sam_data$phenotype == "N", tmpps)
  tabtmp <- getIndDist_onefamily_timepoint(psA, psN, i, dist)
  tab <- rbind(tab, tabtmp)
}
tab_w_tp <- tab

tab_w_tp_long <- melt(tab_w_tp)
p <- ggplot(melt(tab_w_tp), aes(x=variable, y=value)) + 
  geom_boxplot() +
  facet_wrap(~Timepoint)
p + geom_jitter(shape=16, position=position_jitter(0.2))

# run tests to check significance
wilcox.test(tab$DistanceAut, tab$DistanceNeu, paired = TRUE)

```
#Permutation test on mean differences between A and N
```{r}
permutation_meandist_gen <- function(x){
  ptab <- x
  ptab$permu_label<- ptab$phenotype[shuffle(ptab$phenotype)]
  return(mean(ptab$distance[ptab$permu_label == "A"]) -
  mean(ptab$distance[ptab$permu_label == "N"]))

}
tab_w_tp_long <- melt(tab_w_tp)
colnames(tab_w_tp_long) <- c("family", "timepoint", "phenotype", "distance")
tab_w_tp_long$phenotype <- ifelse(tab_w_tp_long$phenotype == "DistanceAut", "A", "N")
permu_means<-replicate(1000, permutation_meandist_gen(tab_w_tp_long))

diff.means <- mean(tab_w_tp_long$distance[tab_w_tp_long$phenotype == "A"]) -
  mean(tab_w_tp_long$distance[tab_w_tp_long$phenotype == "N"])

p_val <- sum(permu_means > diff.means)/ length(permu_means)
hist(permu_means) 
abline(v = diff.means, col = 'red')

```


```{r}
#organized by family

permutation_meandist_gen_by_fam<-function(x){
  ptab <- x
  tmp <- ptab[which(ptab$family == ptab$family[1]),]
  tmp$permu_label<- tmp$phenotype[shuffle(tmp$phenotype)]
  ptab_all <- tmp
  
  for (i in 2:length(unique(ptab$family))){
    tmp <- ptab[which(ptab$family == unique(ptab$family)[i]),]
    tmp$permu_label<- tmp$phenotype[shuffle(tmp$phenotype)]
    ptab_all <- rbind(ptab_all, tmp)
  }
  

  mean(ptab_all$distance[ptab_all$permu_label == "A"]) -
  mean(ptab_all$distance[ptab_all$permu_label == "N"])

}
set.seed(1)
permu_means_by_fam <- replicate(1000, permutation_meandist_gen_by_fam(tab_w_tp_long))


sig <- as.numeric(sum(permu_means >= diff.means))
pval_by_fam <- sig/length(permu_means)

pval_by_fam

{hist(permu_means_by_fam)
 abline(v = diff.means, col = "red")}

{plot(density(permu_means_by_fam))
  abline(v = diff.means, col = "red")}
```

## Permutation test on each set of timepoints independently
```{r}
# Now with difference between A and N at each time point, then taking mean


#Since they are in order by family and timepoint, I can subtract across

#view to make sure
#tab_w_tp_long[which(tab_w_tp_long$phenotype == "A"),]
#tab_w_tp_long[which(tab_w_tp_long$phenotype == "N"),]


fintab_1_2 <- tab_w_tp_long[which(tab_w_tp_long$timepoint == "Timepoint 1-2"),]
fintab_1_3 <- tab_w_tp_long[which(tab_w_tp_long$timepoint == "Timepoint 1-3"),]
fintab_2_3 <- tab_w_tp_long[which(tab_w_tp_long$timepoint == "Timepoint 2-3"),]

set.seed(1)
permu_means_by_fam12 <- replicate(1000, permutation_meandist_gen_by_fam(fintab_1_2))
mean_difference <- mean(fintab_1_2$distance[fintab_1_2$phenotype == "A"] - fintab_1_2$distance[fintab_1_2$phenotype == "N"])
sig <- as.numeric(sum(permu_means_by_fam12 >= mean_difference))
pval_by_fam12 <- sig/length(permu_means)

set.seed(1)
permu_means_by_fam13 <- replicate(1000, permutation_meandist_gen_by_fam(fintab_1_3))
mean_difference <- mean(fintab_1_3$distance[fintab_1_3$phenotype == "A"] - fintab_1_3$distance[fintab_1_3$phenotype == "N"])
sig <- as.numeric(sum(permu_means_by_fam13 >= mean_difference))
pval_by_fam13 <- sig/length(permu_means)


set.seed(1)
permu_means_by_fam23 <- replicate(1000, permutation_meandist_gen_by_fam(fintab_2_3))
mean_difference<-mean(fintab_2_3$distance[fintab_2_3$phenotype == "A"] - fintab_2_3$distance[fintab_2_3$phenotype == "N"])
sig <- as.numeric(sum(permu_means_by_fam23 >= mean_difference))
pval_by_fam23 <- sig/length(permu_means)
```

```{r}
#All_together
permutation_meandist_gen_by_fam_all<-function(x){
  ptab <- x
  tmp <- ptab[which(ptab$family == ptab$family[1]),]
  tmp_time <- tmp[which(tmp$Timepoint == unique(tmp$Timepoint)[1]),]
  tmp_time$permu_label<- tmp_time$phenotype[shuffle(tmp_time$phenotype)]
  tmp_time_all <- tmp_time
  
  for (b in 2:3) {
    tmp_time <- tmp[which(tmp$Timepoint == unique(tmp$Timepoint)[b]),]
    tmp_time$permu_label<- tmp_time$phenotype[shuffle(tmp_time$phenotype)]
    tmp_time_all <- rbind(tmp_time_all, tmp_time)
    
  }
  
  ptab_all <-tmp_time_all
  
  for (i in 2:length(unique(ptab$family))){
  tmp <- ptab[which(ptab$family == unique(ptab$family)[i]),]
  tmp_time <- tmp[which(tmp$Timepoint == unique(tmp$Timepoint)[1]),]
  tmp_time$permu_label<- tmp_time$phenotype[shuffle(tmp_time$phenotype)]
  tmp_time_all <- tmp_time
  
    for (b in 2:3) {
    tmp_time <- tmp[which(tmp$Timepoint == unique(tmp$Timepoint)[b]),]
    tmp_time$permu_label<- tmp_time$phenotype[shuffle(tmp_time$phenotype)]
    tmp_time_all <- rbind(tmp_time_all, tmp_time)
    
    }
  
  ptab_all <- rbind(ptab_all, tmp_time_all)
  }
  

  mean(ptab_all$distance[which(ptab_all$permu_label == "A")]-
  ptab_all$distance[which(ptab_all$permu_label == "N")])

}

permu_means_by_fam_shuffled_while_maintaining_tp<-replicate(1000, permutation_meandist_gen_by_fam(tab_w_tp_long))
mean_difference<-mean(tab_w_tp_long$distance[which(tab_w_tp_long$phenotype == "A")] -tab_w_tp_long$distance[which(tab_w_tp_long$phenotype == "N")])
sig <- as.numeric(sum(permu_means_by_fam_shuffled_while_maintaining_tp >= mean_difference))
pval_by_fam_all<-sig/1000

{plot(density(permu_means_by_fam_shuffled_while_maintaining_tp))
  abline(v = mean_difference, col = "red")}



```




